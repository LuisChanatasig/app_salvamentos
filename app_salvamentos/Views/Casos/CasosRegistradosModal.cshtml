@model IEnumerable<app_salvamentos.Models.CasoListadoDto>


<div class="table-responsive">
    <table id="contenidoCasosModal"
           class="table nowrap dt-responsive align-middle table-hover table-bordered w-100">
        <thead class="table-light">
            <tr>
                <th data-priority="1">ID</th>
                <th data-priority="2">Fecha</th>
                <th data-priority="3">Indemnizado</th>
                <th>Placa</th>
                <th>Marca</th>
                <th>Modelo</th>
                <th>Estado</th>
                <th data-priority="1">Acciones</th>
            </tr>
        </thead>
        <tbody>
            @if (Model != null && Model.Any())
            {
                @foreach (var caso in Model)
                {
                    <tr>
                        <td>@caso.caso_id</td>
                        <td>@caso.fecha_siniestro.ToString("yyyy-MM-dd")</td>
                        <td>@caso.nombre_asegurado</td>
                        <td>@caso.placa</td>
                        <td>@caso.marca</td>
                        <td>@caso.modelo</td>
                        <td>
                            @{
                                string badgeClass = "bg-secondary"; // Default
                                switch (caso.estado_caso.ToUpper())
                                {
                                    case "CREADO":
                                        badgeClass = "bg-warning";
                                        break;
                                    case "ANALIZADO":
                                        badgeClass = "bg-info";
                                        break;
                                    case "FINALIZADO":
                                        badgeClass = "bg-success";
                                        break;
                                        // Añade más casos si tienes otros estados
                                }
                            }
                            <span class="badge @badgeClass">@caso.estado_caso.ToUpper()</span>
                        </td>
                        <td>
                            <div class="d-flex gap-2">
                           
                                <a href="@Url.Action("AnálisisCaso", "Analisis", new { id = caso.caso_id })" class="btn btn-sm btn-soft-primary">
                                    <i class="ri-eye-line"></i> Ver
                                </a>
                            </div>
                        </td>
                    </tr>
                }
            }
            else
            {
                <tr>
                    <td colspan="8" class="text-center">No se encontraron casos.</td>
                </tr>
            }
        </tbody>
    </table>
</div>

<script>
    // Este script se ejecutará una vez que el contenido del modal sea cargado en el DOM.
    // Es crucial que jQuery y DataTables ya estén cargados en la página principal.
    $(document).ready(function () {
        // Destruir cualquier instancia existente de DataTables en esta tabla
        // Esto es útil si el modal se abre y cierra varias veces.
        if ($.fn.DataTable.isDataTable('#contenidoCasosModal')) {
            $('#contenidoCasosModal').DataTable().destroy();
        }

        // Inicializar DataTables para la tabla dentro del modal
        $('#contenidoCasosModal').DataTable({
            responsive: {
                details: {
                    type: 'column',
                    target: 'tr'
                }
            },
            pagingType: 'simple_numbers',
            pageLength: 10,
            language: {
                url: '//cdn.datatables.net/plug-ins/1.11.5/i18n/es-ES.json'
            },
            dom: 'Bfrtip', // Mostrar botones de exportación, búsqueda, etc.
            buttons: [
                { extend: 'copyHtml5', className: 'btn btn-light btn-sm' },
                { extend: 'excelHtml5', className: 'btn btn-light btn-sm' },
                { extend: 'pdfHtml5', className: 'btn btn-light btn-sm' },
                { extend: 'print', className: 'btn btn-light btn-sm' }
            ],
            createdRow: function (row, data) {
                // data[6] es el valor de la columna 'Estado' en el array de datos de la fila
                if (data[6].includes('CREADO')) $(row).addClass('table-warning');
                else if (data[6].includes('ANALIZADO')) $(row).addClass('table-info');
                else if (data[6].includes('FINALIZADO')) $(row).addClass('table-success');
            }
        });

        // Manejar el clic en el botón "Seleccionar"
        $('.select-case-btn').on('click', function() {
            var casoId = $(this).data('caso-id');
            // Aquí puedes llamar a una función en la ventana principal o disparar un evento
            // para pasar el casoId. Por ejemplo, si tienes una función global:
            if (typeof window.onCaseSelected === 'function') {
                window.onCaseSelected(casoId);
            } else {
                // Si no hay una función global, puedes usar un evento personalizado
                $(document).trigger('caseSelected', casoId);
            }
            // Opcional: Cerrar el modal después de seleccionar
            // $('#tuModalId').modal('hide'); // Reemplaza 'tuModalId' con el ID de tu modal Bootstrap
        });
    });
</script>
