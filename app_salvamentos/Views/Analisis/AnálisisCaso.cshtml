@model app_salvamentos.Models.AnalisisCasoViewModel
@using app_salvamentos.Helper
@using Newtonsoft.Json
@{
    ViewBag.Title = "Análisis del Caso";
    Layout = "~/Views/Shared/_Layout.cshtml";
    // Obtén la instancia de HttpContext de la vista
    var ctx = ViewContext.HttpContext;
    var usuarioId = UsuarioSesionHelper.UsuarioId(ctx);
    var perfilId = UsuarioSesionHelper.RolId(ctx);
    var usuarioLogin = UsuarioSesionHelper.UsuarioLogin(ctx);
    var perfilNombre = UsuarioSesionHelper.PerfilNombre(ctx);
    var nombres = UsuarioSesionHelper.Nombres(ctx);
    var fechaLimitePago = string.IsNullOrEmpty(Model.CasoDetalle.Resumen?.FechaLimitePagoSriFormatted)
      ? DateTime.Today.ToString("yyyy-MM-dd")
      : Model.CasoDetalle.Resumen.FechaLimitePagoSriFormatted;
}

@{
    // 1. Prepara los tipos por ámbito
    var tiposCaso = Model.TiposDocumentoCaso ?? new List<SelectListItem>();
    var tiposAsegurado = Model.TiposDocumentoAsegurado ?? new List<SelectListItem>();
    var ambitos = new Dictionary<string, List<SelectListItem>>(StringComparer.OrdinalIgnoreCase)
    {
        { "CASO",      tiposCaso },
        { "ASEGURADO", tiposAsegurado }
    };

    // 2. Asegura que AllDocuments nunca sea null y filtra
    var allDocs = Model.AllDocuments
                  ?? new List<DocumentoDetalleDto>();

    var documentosFiltrados = allDocs
        .Where(doc =>
            doc != null
            && !string.IsNullOrWhiteSpace(doc.ambito_documento)
            && ambitos.ContainsKey(doc.ambito_documento)
        )
        .ToList();
}
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h4 class="card-title mb-0">🔍 Análisis del Caso - ID @Model.CasoDetalle.numero_reclamo</h4>
            </div>

            <div class="card-body">
                @* Mostrar mensajes de error o éxito de TempData *@
                @if (TempData["ErrorMessage"] != null)
                {
                    <div class="alert alert-danger alert-dismissible fade show" role="alert">
                        @TempData["ErrorMessage"]
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                }
                @if (TempData["SuccessMessage"] != null)
                {
                    <div class="alert alert-success alert-dismissible fade show" role="alert">
                        @TempData["SuccessMessage"]
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                }
                <form id="crearAnalisisForm" method="post" class="row g-3 needs-validation" novalidate enctype="multipart/form-data">

                    <input type="hidden" name="CasoId" value="@Model.CasoDetalle.caso_id"/>
                    <input type="hidden" name="AseguradoId" value="@Model.CasoDetalle.asegurado_id"/>
                    <input type="hidden" name="VehiculoId" value="@Model.CasoDetalle.vehiculo_id"/>
                    <input type="hidden" name="NumeroReclamo" value="@Model.CasoDetalle.numero_reclamo"/>
                    <input type="hidden" name="UsuarioId" value="@usuarioId" />
         

                    <!-- Tabs Navigation -->
                    <ul class="nav nav-tabs nav-tabs-custom nav-success mb-3" role="tablist" id="tabsChecklist">
                        <li class="nav-item">
                            <a class="nav-link active" data-bs-toggle="tab" href="#resumen" role="tab" id="tabResumen">
                                <i class="ri-file-info-line align-middle me-1"></i> Resumen del Caso <span class="badge bg-light text-muted ms-1" id="statusResumen">⏳</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" data-bs-toggle="tab" href="#documentos" role="tab" id="tabDocumentos">
                                <i class="ri-folder-line align-middle me-1"></i> Documentos <span class="badge bg-light text-muted ms-1" id="statusDocumentos">⏳</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" data-bs-toggle="tab" href="#valores" role="tab" id="tabValores">
                                <i class="ri-money-dollar-circle-line align-middle me-1"></i> Valores Comerciales <span class="badge bg-light text-muted ms-1" id="statusValores">⏳</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" data-bs-toggle="tab" href="#danos" role="tab" id="tabDanos">
                                <i class="ri-tools-line align-middle me-1"></i> Daños <span class="badge bg-light text-muted ms-1" id="statusDanos">⏳</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" data-bs-toggle="tab" href="#partes" role="tab" id="tabPartes">
                                <i class="ri-car-wrench-line align-middle me-1"></i> Partes <span class="badge bg-light text-muted ms-1" id="statusPartes">⏳</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" data-bs-toggle="tab" href="#resumenfinal" role="tab" id="tabFinal">
                                <i class="ri-clipboard-line align-middle me-1"></i> Final <span class="badge bg-light text-muted ms-1" id="statusFinal">⏳</span>
                            </a>
                        </li>
                    </ul>

                    <!-- Tabs Content -->
                    <div class="tab-content text-muted">
                        <!-- Tab 1: Resumen del caso -->
                        <div class="tab-pane fade show active" id="resumen" role="tabpanel">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label">Nombre del Asegurado</label>
                                    <input type="text" class="form-control" id="nombreCompleto" name="NombreCompleto" value="@Model.CasoDetalle.nombre_asegurado" />
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Fecha del Siniestro</label>
                                    <input type="date" class="form-control" id="fechaSiniestro" name="FechaSiniestro"
                                           value="@(Model.CasoDetalle.fecha_siniestro.HasValue ? Model.CasoDetalle.fecha_siniestro.Value.ToString("yyyy-MM-dd") : string.Empty)" />
                                </div>

                                <div class="col-md-4">
                                    <label class="form-label">Marca</label>
                                    <input type="text" id="vehiculoMarca" class="form-control" value="@Model.CasoDetalle.marca" />
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Modelo</label>
                                    <input type="text" id="vehiculoModelo" class="form-control" value="@Model.CasoDetalle.modelo" />
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Año</label>
                                    <input type="number" id="vehiculoAnio" class="form-control"
                                           value="@(Model.CasoDetalle.anio.HasValue ? Model.CasoDetalle.anio.ToString() : "")" />
                                </div>

                                <div class="col-md-6">
                                    <label class="form-label">Placa</label>
                                    <input type="text" id="vehiculoPlaca" class="form-control" value="@Model.CasoDetalle.placa" />
                                </div>

                                <div class="col-md-6" >
                                    <label class="form-label">Número de Reclamo</label>
                                    <input type="text" id="numeroReclamo" nam class="form-control" value="@Model.CasoDetalle.numero_reclamo" readonly />
                                </div>
                            </div>

                            <hr class="my-4" />

                            <h5 class="mb-3">🛠️ Información técnica adicional</h5>
                            <div class="row g-3">
                                <div class="col-md-4">
                                    <label class="form-label">Tipo de Vehículo</label>
                                    <input type="text" id="tipoVehiculo" class="form-control" value="@Model.CasoDetalle.tipo_vehiculo" />
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Transmisión</label>
                                    <input type="text" id="vehiculoTransmision" class="form-control" value="@Model.CasoDetalle.transmision" />
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Combustible</label>
                                    <input type="text" id="vehiculoCombustible" class="form-control" value="@Model.CasoDetalle.combustible" />
                                </div>

                                <div class="col-md-6">
                                    <label class="form-label">Color</label>
                                    <input type="text" id="vehiculoColor" class="form-control" value="@Model.CasoDetalle.color" />
                                </div>

                                <div class="col-md-6">
                                    <label class="form-label">¿Mantiene Gravamen?</label>
                                    <select class="form-select" id="vehiculoGravamen" asp-for="CasoDetalle.gravamen">
                                        <option value="">Seleccione</option>
                                        <option value="SI">Sí</option>
                                        <option value="NO">No</option>
                                    </select>
                                </div>

                                <div class="col-md-6">
                                    <label class="form-label">Placas Metálicas</label>
                                    <select class="form-select" id="vehiculoPlacasMetalicas" asp-for="CasoDetalle.placas_metalicas">
                                        <option value="">Seleccione</option>
                                        <option value="SI">Sí</option>
                                        <option value="NO">No</option>
                                    </select>
                                </div>

                                <div class="col-md-6">
                                    <label class="form-label">¿Se encuentra el radio en el vehículo?</label>
                                    <select class="form-select" id="vehiculoRadio" asp-for="CasoDetalle.radio_vehiculo">
                                        <option value="">Seleccione</option>
                                        <option value="SI">Sí</option>
                                        <option value="NO">No</option>
                                    </select>
                                </div>

                                <div class="col-md-6">
                                    <label class="form-label">Cilindraje</label>
                                    <input type="text" id="vehiculoCilindraje" class="form-control" value="@Model.CasoDetalle.cilindraje" />
                                </div>

                                <div class="col-md-6">
                                    <label class="form-label">Número de Motor</label>
                                    <input type="text" id="vehiculoNumeroMotor" class="form-control" value="@Model.CasoDetalle.numero_motor" />
                                </div>

                                <div class="col-md-6">
                                    <label class="form-label">Número de Chasis</label>
                                    <input type="text" id="vehiculoNumeroChasis" class="form-control" value="@Model.CasoDetalle.numero_chasis" />
                                </div>

                                <div class="col-md-6">
                                    <label class="form-label">Estado del Vehículo</label>
                                    <input type="text" class="form-control" id="vehiculoEstado" placeholder="Ej. Nuevo, Usado, Reparado" value="@Model.CasoDetalle.estado_vehiculo" />
                                </div>

                                <div class="col-12">
                                    <label class="form-label">Observaciones del vehículo</label>
                                    <textarea class="form-control" rows="3" id="vehiculoObservaciones">@Model.CasoDetalle.observaciones_vehiculo</textarea>
                                </div>
                            </div>

                            <div class="d-flex justify-content-end mt-4">
                                <button type="button" class="btn btn-secondary me-2" disabled>Anterior</button>
                                <button type="button" class="btn btn-primary btn-next-tab" data-target="#documentos">Siguiente</button>
                            </div>
                        </div>

                        <!-- Tab 2: Documentos -->
                        <div class="tab-pane fade" id="documentos" role="tabpanel">
                            <div class="row g-3">
                                <div class="col-md-4">
                                    <label class="form-label">Categoría del Documento</label>
                                    <select class="form-select" id="categoriaDocumento">
                                        <optgroup label="Documentos del Asegurado">
                                            @foreach (var tipo in Model.TiposDocumentoAsegurado)
                                            {
                                                <option value="@tipo.Value" data-ambito="ASEGURADO">@tipo.Text</option>
                                            }
                                        </optgroup>
                                        <optgroup label="Documentos del Caso">
                                            @foreach (var tipo in Model.TiposDocumentoCaso)
                                            {
                                                if (tipo.Text != "Fotos del Siniestro")
                                                {
                                                    <option value="@tipo.Value" data-ambito="CASO">@tipo.Text</option>
                                                }
                                            }
                                        </optgroup>
                                    </select>
                                    <div class="invalid-feedback">Por favor, seleccione una categoría.</div>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Seleccionar archivos</label>
                                    <input type="file" id="archivosDocumento" class="form-control" multiple
                                           accept="image/*,application/pdf,.doc,.docx,.xls,.xlsx" />
                                    <div class="invalid-feedback">Por favor, seleccione al menos un archivo.</div>
                                </div>
                                <div class="col-md-2 d-flex align-items-end">
                                    <button type="button" class="btn btn-primary w-100" id="btnAgregarDoc">
                                        <i class="ri-upload-cloud-line me-1"></i> Agregar
                                    </button>
                                </div>
                                <div class="col-12">
                                    <label class="form-label">Observaciones del Documento</label>
                                    <textarea class="form-control" id="observacionesDocumento" rows="2"
                                              placeholder="Observaciones sobre el documento"></textarea>
                                </div>
                            </div>

                            <hr class="my-4" />

                            <h6>📂 Documentos cargados:</h6>

                            <div class="row" id="listaDocumentos">
                                @if (documentosFiltrados.Any())
                                {
                                    @foreach (var doc in documentosFiltrados)
                                    {
                                        // Datos del archivo
                                        string fileName = doc.nombre_archivo ?? "";
                                        string fileMime = DocumentDisplayHelper.GetMimeTypeFromFileName(fileName);
                                        string iconClass = DocumentDisplayHelper.GetIconClass(fileMime);
                                        string colorClass = DocumentDisplayHelper.GetColorClass(fileMime);

                                        // Texto del tipo de documento
                                        var listaTipos = ambitos[doc.ambito_documento];
                                        string tipoDocumentoText = listaTipos
                                        .FirstOrDefault(t => t.Value == doc.tipo_documento_id.ToString())
                                        ?.Text
                                        ?? "Tipo Desconocido";

                                        <div class="col-md-4 col-sm-6 mb-3 fade-in-up"
                                             data-doc-id="@doc.documento_id"
                                             data-preview-url="@doc.RutaPublica">
                                            <div class="card border card-animate">
                                                <div class="card-body">
                                                    <div class="d-flex align-items-center">
                                                        <div class="flex-shrink-0 me-3">
                                                            <i class="@iconClass fs-2 @colorClass"></i>
                                                        </div>
                                                        <div class="flex-grow-1">
                                                            <h6 class="mb-1 text-truncate">@fileName</h6>
                                                            <small class="text-muted">
                                                                @tipoDocumentoText (@doc.ambito_documento)
                                                            </small>
                                                        </div>
                                                        <div class="flex-shrink-0">
                                                            <button type="button"
                                                                    class="btn btn-sm btn-light p-0 remove-doc-btn"
                                                                    data-bs-toggle="tooltip"
                                                                    data-bs-placement="top"
                                                                    title="Eliminar"
                                                                    data-doc-id="@doc.documento_id">
                                                                <i class="ri-delete-bin-line text-danger"></i>
                                                            </button>
                                                            @if (!string.IsNullOrEmpty(doc.ruta_fisica))
                                                            {
                                                                <button type="button"
                                                                        class="btn btn-sm btn-light p-0 preview-doc-btn ms-1"
                                                                        data-bs-toggle="tooltip"
                                                                        data-bs-placement="top"
                                                                        title="Previsualizar"
                                                                        data-preview-url="@doc.ruta_fisica">
                                                                    <i class="ri-eye-line text-info"></i>
                                                                </button>
                                                            }
                                                        </div>
                                                    </div>
                                                    @if (!string.IsNullOrEmpty(doc.observaciones))
                                                    {
                                                        <p class="text-muted mt-2 mb-0 text-wrap">
                                                            <small>Obs: @doc.observaciones</small>
                                                        </p>
                                                    }
                                                </div>
                                            </div>
                                        </div>
                                    }
                                }
                                else
                                {
                                    <p class="text-muted">No hay documentos de CASO o ASEGURADO.</p>
                                }
                            </div>
                            <div class="d-flex justify-content-between mt-4">
                                <button type="button" class="btn btn-secondary btn-prev-tab">
                                    <i class="ri-arrow-left-line align-bottom me-1"></i> Anterior
                                </button>

                                <button type="button" class="btn btn-primary btn-next-tab">
                                    Siguiente <i class="ri-arrow-right-line align-bottom ms-1"></i>
                                </button>
                            </div>

                        </div>

                        <!-- Tab 3: Valores Comerciales -->
                        <div class="tab-pane fade" id="valores" role="tabpanel">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label">
                                        Pago Matrícula SRI hasta
                                    </label>
                             
                                    <input asp-for="CasoDetalle.Resumen.FechaLimitePagoSri"
                                           class="form-control"
                                           type="date" id="fechalimitepago" />
                                    <span asp-validation-for="CasoDetalle.Resumen.FechaLimitePagoSri"
                                          class="text-danger"></span>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">
                                        Número de multas
                                    </label>
                                    <!-- ID único para el número de multas -->
                                    <input type="number" class="form-control" id="num_multas" min="0" value="@Model.CasoDetalle.Resumen.NumeroMultas" />
                                </div>

                                <!-- Contenedor para los campos de valor de multa individuales -->
                                <div class="col-12" id="individual_multas_container">
                                    <!-- Aquí se generarán dinámicamente los campos para cada multa -->
                                </div>

                                <div class="col-md-6">
                                    <label class="form-label">Valor asegurado</label>
                                    <input type="text" min="0" class="form-control" id="valorAsegurado" placeholder="Ej. 9500" value="@Model.CasoDetalle.Resumen.ValorAsegurado" />
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Valores pendientes por matrícula</label>
                                    <input type="text" class="form-control" id="valorMatriculaPendiente"
                                           min="0" value="@Model.CasoDetalle.Resumen.ValorMatriculaPendiente" />
                                </div>

                                <hr class="my-2">
                                <h5 class="mt-4">💲 Valores Comerciales del Mercado</h5>

                                <div class="col-md-6">
                                    <label class="form-label">Patio Tuerca</label>
                                    <div class="input-group">
                                        <input type="text" class="form-control valor-comercial-input"
                                               id="valorPatioTuerca" placeholder="Valor"
                                               value="@Model.CasoDetalle.ValorPatioTuerca" />
                                        <input type="file" class="form-control file-input-valor" id="filePatioTuerca"
                                               accept="image/*,application/pdf" />
                                        <button type="button" class="btn btn-outline-secondary preview-valor-btn d-none"
                                                data-file-id="filePatioTuerca" title="Previsualizar">
                                            <i class="ri-eye-line text-info"></i>
                                        </button>
                                        <button type="button" class="btn btn-outline-danger remove-valor-btn d-none"
                                                data-file-id="filePatioTuerca" title="Eliminar">
                                            <i class="ri-delete-bin-line"></i>
                                        </button>
                                    </div>
                                    <div class="text-muted mt-1 small" id="fileNamePatioTuerca"></div>
                                </div>

                                <div class="col-md-6">
                                    <label class="form-label">AEADE</label>
                                    <div class="input-group">
                                        <input type="text" class="form-control valor-comercial-input" id="valorAEADE"
                                               placeholder="Valor" value="@Model.CasoDetalle.ValorAEADE" />
                                        <input type="file" class="form-control file-input-valor" id="fileAEADE"
                                               accept="image/*,application/pdf" />
                                        <button type="button" class="btn btn-outline-secondary preview-valor-btn d-none"
                                                data-file-id="fileAEADE" title="Previsualizar">
                                            <i class="ri-eye-line text-info"></i>
                                        </button>
                                        <button type="button" class="btn btn-outline-danger remove-valor-btn d-none"
                                                data-file-id="fileAEADE" title="Eliminar">
                                            <i class="ri-delete-bin-line"></i>
                                        </button>
                                    </div>
                                    <div class="text-muted mt-1 small" id="fileNameAEADE"></div>
                                </div>

                                <div class="col-md-6">
                                    <label class="form-label">Marketplace</label>
                                    <div class="input-group">
                                        <input type="text" class="form-control valor-comercial-input"
                                               id="valorMarketplace" placeholder="Valor"
                                               value="@Model.CasoDetalle.ValorMarketplace" />
                                        <input type="file" class="form-control file-input-valor" id="fileMarketplace"
                                               accept="image/*,application/pdf" />
                                        <button type="button" class="btn btn-outline-secondary preview-valor-btn d-none"
                                                data-file-id="fileMarketplace" title="Previsualizar">
                                            <i class="ri-eye-line text-info"></i>
                                        </button>
                                        <button type="button" class="btn btn-outline-danger remove-valor-btn d-none"
                                                data-file-id="fileMarketplace" title="Eliminar">
                                            <i class="ri-delete-bin-line"></i>
                                        </button>
                                    </div>
                                    <div class="text-muted mt-1 small" id="fileNameMarketplace"></div>
                                </div>

                                <div class="col-md-6">
                                    <label class="form-label">Hugo Vargas</label>
                                    <div class="input-group">
                                        <input type="text" class="form-control valor-comercial-input" id="valorHugoVargas"
                                               placeholder="Valor" value="@Model.CasoDetalle.ValorHugoVargas" />
                                        <input type="file" class="form-control file-input-valor" id="fileHugoVargas"
                                               accept="image/*,application/pdf" />
                                        <button type="button" class="btn btn-outline-secondary preview-valor-btn d-none"
                                                data-file-id="fileHugoVargas" title="Previsualizar">
                                            <i class="ri-eye-line text-info"></i>
                                        </button>
                                        <button type="button" class="btn btn-outline-danger remove-valor-btn d-none"
                                                data-file-id="fileHugoVargas" title="Eliminar">
                                            <i class="ri-delete-bin-line"></i>
                                        </button>
                                    </div>
                                    <div class="text-muted mt-1 small" id="fileNameHugoVargas"></div>
                                </div>

                                <div class="col-md-6">
                                    <label class="form-label">Otros</label>
                                    <div class="input-group">
                                        <input type="text" class="form-control valor-comercial-input" id="valorOtros"
                                               placeholder="Valor" value="@Model.CasoDetalle.ValorOtros" />
                                        <input type="file" class="form-control file-input-valor" id="fileOtros"
                                               accept="image/*,application/pdf" />
                                        <button type="button" class="btn btn-outline-secondary preview-valor-btn d-none"
                                                data-file-id="fileOtros" title="Previsualizar">
                                            <i class="ri-eye-line text-info"></i>
                                        </button>
                                        <button type="button" class="btn btn-outline-danger remove-valor-btn d-none"
                                                data-file-id="fileOtros" title="Eliminar">
                                            <i class="ri-delete-bin-line"></i>
                                        </button>
                                    </div>
                                    <div class="text-muted mt-1 small" id="fileNameOtros"></div>
                                </div>

                                <!-- Nuevos campos de avalúo -->
                                <div class="col-md-6">
                                    <label class="form-label">Precio Comercial Sugerido</label>
                                    <input type="number" class="form-control" id="precioComercialSugerido" placeholder="150000" />
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Precio Base</label>
                                    <input type="number" class="form-control" id="precioBase" placeholder="150000" />
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Precio Estimado Venta Vehículo</label>
                                    <input type="number" class="form-control" id="precioEstimadoVentaVehiculo" placeholder="Auto-calculado" readonly />
                                </div>

                                <div class="col-md-6">
                                    <label class="form-label">Promedio Calculado</label>
                                    <input type="number" class="form-control" id="promedioCalculado"
                                           placeholder="Auto-calculado" readonly />
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Promedio - Valor matrícula</label>
                                    <input type="number" class="form-control" id="promedioNeto"
                                           placeholder="Auto-calculado" readonly />
                                </div>

                                <!-- Campo para mostrar el total de multas -->
                                <div class="col-md-6">
                                    <label class="form-label">Total de Multas</label>
                                    <input type="number" class="form-control" id="total_multas_display"
                                           placeholder="Auto-calculado" readonly  value="@Model.CasoDetalle.Resumen.ValorMultasTotal"/>
                                </div>
                                <!-- NUEVO: Documentos de Valor Comercial -->
                                <h6 class="mt-4">📂 Documentos de Valor Comercial:</h6>
                                <div class="row g-3" id="listaValoresComerciales">
                                    <!-- Aquí llenaremos desde JS -->
                                </div>
                                <hr class="my-2">
                                <h5 class="mt-4">📝 Detalles del Avalúo</h5>


                                <div class="col-md-6" hidden>
                                    <label class="form-label">Número de avaluo</label>
                                    <input type="text" class="form-control" id="numeroAvaluo"value="@Model.CasoDetalle.numero_avaluo" />
                                </div>

                                <div class="col-md-6">
                                    <label class="form-label">Avalúo realizado mediante</label>
                                    <input type="text" class="form-control" name="MetodoAvaluo" id="avaluoRealizadoMediante" value="@Model.CasoDetalle.metodo_avaluo" placeholder="Ej. Peritaje, Estimación" />
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Dirección (del avalúo)</label>
                                    <input type="text" class="form-control" name="DireccionAvaluo" id="direccionAvaluo" placeholder="Ej. Calle Principal 123" value="@Model.CasoDetalle.direccion_avaluo" />
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Solicitud Avalúo</label>
                                    <input type="date" class="form-control" id="fechaSolicitudAvaluo"
                                           value="@(@Model.CasoDetalle.fecha_solicitud_avaluo?.ToString("yyyy-MM-dd") ?? DateTime.Now.ToString("yyyy-MM-dd"))" />
                                </div>
                                <div class="col-md-6" hidden>
                                    <label class="form-label">Elaboración Avalúo</label>
                                    <input type="date" class="form-control" id="fechaElaboracionAvaluo"/>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Elaborado por</label>
                                    <input type="text" class="form-control" id="elaboradoPor" placeholder="Nombre del perito/persona" value="@Model.CasoDetalle.creado_por" disabled/>
                                </div>
                                <div class="col-12">
                                    <label class="form-label">Comentarios del Avalúo</label>
                                    <textarea class="form-control" id="comentariosAvaluo" name="ComentariosAvaluo" rows="3" placeholder="Comentarios generales sobre el avalúo" asp-for="CasoDetalle.comentarios_avaluo" ></textarea>
                                </div>
                                <div class="col-12">
                                    <label class="form-label">Nota: Avalúo válido por</label>
                                    <textarea class="form-control" id="notaAvaluoValidoPor" name="NotasAvaluo" rows="2" placeholder="Notas sobre la validez del avalúo" asp-for="CasoDetalle.notas_avaluo"></textarea>
                                </div>
                            </div>
                            <div class="d-flex justify-content-between mt-4">
                                <button type="button" class="btn btn-secondary btn-prev-tab">
                                    <i class="ri-arrow-left-line align-bottom me-1"></i> Anterior
                                </button>

                                <button type="button" class="btn btn-primary btn-next-tab">
                                    Siguiente <i class="ri-arrow-right-line align-bottom ms-1"></i>
                                </button>
                            </div>

                        </div>


                        <!-- Tab 4: Daños y Observaciones  -->
                        <div class="tab-pane fade" id="danos" role="tabpanel">
                            <div class="mb-3">
                                <label class="form-label">Subir fotos de daños</label>
                                <input type="file" id="fotosDanoInput" class="form-control" multiple accept="image/*" />
                            </div>

                            <hr class="my-4" />

                            <h6>
                                📸 Fotos de daños cargadas: <span class="badge bg-light text-muted ms-1"
                                                                  id="countDanos">0</span>
                            </h6>
                            <div class="row g-3" id="previewDanos">
                                <!-- Aquí se mostrarán las imágenes cargadas con observación y eliminar -->
                            </div>

                            <div class="text-end mt-3">
                                <button class="btn btn-success" id="btnValidarFotos">
                                    <i class="ri-check-line me-1"></i> Validar Observaciones
                                </button>
                            </div>
                            <div class="d-flex justify-content-between mt-4">
                                <button type="button" class="btn btn-secondary btn-prev-tab">
                                    <i class="ri-arrow-left-line align-bottom me-1"></i> Anterior
                                </button>

                                <button type="button" class="btn btn-primary btn-next-tab">
                                    Siguiente <i class="ri-arrow-right-line align-bottom ms-1"></i>
                                </button>
                            </div>

                        </div>

                        <!-- Tab 5: Partes  -->
                        <div class="tab-pane fade" id="partes" role="tabpanel">
                            <div class="table-responsive">
                                <table class="table table-bordered align-middle">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Parte</th>
                                            <th>Valor Nuevo</th>
                                            <th>Valor Depreciado</th>
                                            <th>Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tablaPartes">
                                        <!-- Filas dinámicas -->
                                    </tbody>
                                </table>
                            </div>

                            <div class="d-flex justify-content-end mb-4">
                                <button type="button" class="btn btn-sm btn-outline-success" id="btnAgregarParte">
                                    <i class="ri-add-line"></i> Agregar Parte
                                </button>
                            </div>

                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label">% de Daño</label>
                                    <input type="number" class="form-control" asp-for="CasoDetalle.Resumen.PorcentajeDano"
                                           id="porcentajeDano" placeholder="Ej. 30" min="0" max="100"
                                           value="@string.Format("{0:0}", Model.CasoDetalle.Resumen.PorcentajeDano)" />


                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Valor Calculado de Salvamento</label>
                                    <input type="text" class="form-control" id="valorSalvamento"  asp-for="CasoDetalle.Resumen.ValorSalvamento"/>
                                </div>
                            </div>
                            <div class="d-flex justify-content-between mt-4">
                                <button type="button" class="btn btn-secondary btn-prev-tab">
                                    <i class="ri-arrow-left-line align-bottom me-1"></i> Anterior
                                </button>

                                <button type="button" class="btn btn-primary btn-next-tab">
                                    Siguiente <i class="ri-arrow-right-line align-bottom ms-1"></i>
                                </button>
                            </div>

                        </div>

                        <!-- Tab 6: Resumen Final (mantengo el contenido original) -->
                        <div class="tab-pane fade" id="resumenfinal" role="tabpanel">
                            <div class="row g-3">
                                <div class="col-12">
                                    <h5 class="mb-3">🧾 Resumen del Análisis</h5>
                                    <ul class="list-group">
                                        <li class="list-group-item d-flex justify-content-between">
                                            <strong>Nombre:</strong> <span>@Model.CasoDetalle.nombre_asegurado</span>
                                        </li>
                                        <li class="list-group-item d-flex justify-content-between">
                                            <strong>Placa:</strong> <span>@Model.CasoDetalle.placa</span>
                                        </li>
                                        <li class="list-group-item d-flex justify-content-between">
                                            <strong>Marca / Modelo:</strong> <span>
                                                @Model.CasoDetalle.marca
                                                @Model.CasoDetalle.modelo (@(Model.CasoDetalle.anio.HasValue ?
                                                Model.CasoDetalle.anio.ToString() : "N/A"))
                                            </span>
                                        </li>
                                        <li class="list-group-item d-flex justify-content-between">
                                            <strong>Valor Asegurado:</strong> <span id="resumenValorAsegurado">$9,500</span>
                                            @* Hardcoded, si viene de DB, usar @Model.ValorAsegurado *@
                                        </li>
                                        <li class="list-group-item d-flex justify-content-between">
                                            <strong>Promedio Comercial:</strong> <span id="resumenPromedioComercial">$8,800</span> @* Hardcoded *@
                                        </li>
                                        <li class="list-group-item d-flex justify-content-between">
                                            <strong>Valor Pendiente Matrícula:</strong> <span id="resumenValorMatricula">$120</span> @* Hardcoded *@
                                        </li>
                                        <li class="list-group-item d-flex justify-content-between">
                                            <strong>Promedio Neto:</strong> <span id="resumenPromedioNeto">$8,680</span> @* Hardcoded *@
                                        </li>
                                        <li class="list-group-item d-flex justify-content-between">
                                            <strong>% de Daño:</strong> <span id="resumenPorcentajeDano">30%</span> @* Hardcoded *@
                                        </li>
                                        <li class="list-group-item d-flex justify-content-between">
                                            <strong>Valor Salvamento:</strong> <span id="resumenValorSalvamento">$1,200</span> @* Hardcoded *@
                                        </li>
                                    </ul>
                                </div>
                            </div>
                            <div class="d-flex justify-content-between mt-4">
                                <button type="button" class="btn btn-secondary btn-prev-tab">
                                    <i class="ri-arrow-left-line align-bottom me-1"></i> Anterior
                                </button>

                                <button type="button" class="btn btn-primary btn-next-tab">
                                    Siguiente <i class="ri-arrow-right-line align-bottom ms-1"></i>
                                </button>
                            </div>

                            <div class="text-end mt-4">
                                <button type="submit" class="btn btn-success">
                                    <i class="ri-check-line align-bottom me-1"></i> Finalizar Creación
                                </button>
                            </div>

                        </div>
                    </div>

                </form>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Previsualización de Documentos -->
<div class="modal fade" id="previewModal" tabindex="-1" aria-labelledby="previewModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="previewModalLabel">Previsualización del Documento</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center" id="previewContent">
                <!-- Contenido de la previsualización (imagen o iframe de PDF) -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>



@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script> @* Asegúrate de que jQuery esté cargado *@
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script> @* Asegúrate de que Bootstrap JS esté cargado para los tooltips y modales *@

    <script>
        // =====================================================================
        // Variables Globales y Configuración de URLs de API
        // =====================================================================
        var crearCasoApiUrl = '@Url.Action("RegistrarDatosFinancieros", "Analisis")'; // URL para registrar datos financieros
        var API_DOCUMENTOS_BASE_URL = '@Url.Action("BorrarDocumento", "Casos")'; // URL base para operaciones con documentos (ej. borrar)
        var API_CASOS_BASE_URL = '@Url.Action("ObtenerArchivo", "Casos")'; // URL base para obtener archivos de casos (previsualización/descarga)



    </script>

    <script>
        window.datosCaso = {
            Partes: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.CasoDetalle.Partes ?? new List<ParteDto>()))
        };
    </script>

    <script>
        // =====================================================================
        // Funciones Auxiliares Globales (MIME, Iconos, Colores)
        // =====================================================================

        // Función para obtener el tipo MIME de un archivo basándose en su extensión.
        function getFileMimeType(extension) {
            if (!extension) return "application/octet-stream";
            switch (extension.toLowerCase()) {
                case "jpg":
                case "jpeg": return "image/jpeg";
                case "png": return "image/png";
                case "gif": return "image/gif";
                case "pdf": return "application/pdf";
                case "doc":
                case "docx": return "application/msword";
                case "xls":
                case "xlsx": return "application/vnd.ms-excel";
                // Añade más tipos si es necesario
                default: return "application/octet-stream";
            }
        }

        function getIconByType(mimeType) {
            if (!mimeType) return "ri-file-line";
            mimeType = mimeType.toLowerCase(); // Normalizar a minúsculas para comparación
            if (mimeType.includes("pdf")) return "ri-file-pdf-line";
            if (mimeType.includes("word") || mimeType.includes("doc")) return "ri-file-word-line";
            if (mimeType.includes("excel") || mimeType.includes("sheet")) return "ri-file-excel-line";
            if (mimeType.includes("zip") || mimeType.includes("compressed")) return "ri-file-zip-line";
            if (mimeType.includes("audio")) return "ri-music-line";
            if (mimeType.includes("video")) return "ri-movie-line";
            if (mimeType.includes("text")) return "ri-file-text-line";
            if (mimeType.includes("image")) return "ri-image-line";
            return "ri-file-line";
        }

        function getColorByType(mimeType) {
            if (!mimeType) return "text-secondary";
            mimeType = mimeType.toLowerCase(); // Normalizar a minúsculas para comparación
            if (mimeType.includes("pdf")) return "text-danger";
            if (mimeType.includes("word") || mimeType.includes("doc")) return "text-primary";
            if (mimeType.includes("excel") || mimeType.includes("sheet")) return "text-success";
            if (mimeType.includes("zip")) return "text-warning";
            if (mimeType.includes("audio")) return "text-info";
            if (mimeType.includes("video")) return "text-purple";
            if (mimeType.includes("text")) return "text-dark";
            if (mimeType.includes("image")) return "text-info";
            return "text-muted";
        }
    </script>

    <script>
        // =====================================================================
        // Manejo de Mensajes de SweetAlert desde TempData (Errores/Éxitos)
        // =====================================================================
        var errorMessage = '@Html.Raw(TempData["ErrorMessage"])';
        var successMessage = '@Html.Raw(TempData["SuccessMessage"])';

        if (errorMessage) {
            Swal.fire({
                icon: 'error',
                title: '¡Error!',
                text: errorMessage,
                confirmButtonText: 'Aceptar'
            });
        } else if (successMessage) {
            Swal.fire({
                icon: 'success',
                title: '¡Éxito!',
                text: successMessage,
                confirmButtonText: 'Ok'
            });
        }

        @if (TempData["FormErrors"] != null)
        {
                <div class="alert alert-danger" role="alert">
                @Html.Raw(TempData["FormErrors"])
                </div>
        }
    </script>

    <script>
        // =====================================================================
        // Inicialización de Documentos Cargados (window.loadedDocuments)
        // =====================================================================

        // Serializa los documentos existentes desde el modelo de la vista (C#) a JavaScript
        // Se asume que Model.CasoDetalle tiene propiedades como DocumentosCaso, DocumentosAsegurado, etc.
        var initialAllDocsData = @Html.Raw(JsonConvert.SerializeObject(new
            {
                caso = Model.CasoDetalle?.DocumentosCaso ?? new List<DocumentoDetalleDto>(),
                asegurado = Model.CasoDetalle?.DocumentosAsegurado ?? new List<DocumentoDetalleDto>(),
                valorComercial = Model.CasoDetalle?.DocumentosValorComercial ?? new List<DocumentoDetalleDto>(),
                dano = Model.CasoDetalle?.DocumentosDano ?? new List<DocumentoDetalleDto>()
            }));

        // Inicializa el objeto global loadedDocuments.
        // Se asegura que cada ámbito sea un array, incluso si está vacío.
        window.loadedDocuments = {
            caso: initialAllDocsData.caso || [],
            asegurado: initialAllDocsData.asegurado || [],
            valorComercial: initialAllDocsData.valorComercial || [],
            dano: initialAllDocsData.dano || []
        };

        // Normaliza los datos de los documentos cargados desde la BD para su uso en el frontend.
        // Esto es crucial para asegurar que tengan propiedades como uiIndex, tipo_mime,
        // nombre_tipo_documento y ambito_documento con valores consistentes.
        Object.keys(window.loadedDocuments).forEach(ambitoKey => {
            window.loadedDocuments[ambitoKey].forEach(doc => {
                // Genera un uiIndex único si no existe (para identificar en la UI)
                if (typeof doc.uiIndex === 'undefined' || doc.uiIndex === null) {
                    doc.uiIndex = crypto.randomUUID();
                }

                // Asegura el tipo MIME:
                // 1. Usa doc.tipo_mime si ya viene de la BD.
                // 2. Si no, calcúlalo de la extensión del archivo.
                // 3. Si no hay nombre de archivo, usa un genérico.
                doc.tipo_mime = doc.tipo_mime || getFileMimeType((doc.nombre_archivo || "").split(".").pop() || "");

                // Asegura el nombre del tipo de documento para la UI:
                // 1. Usa doc.nombre_tipo_documento si ya viene de la BD (es el más descriptivo).
                // 2. Si no, usa doc.nombre_tipo (que parece ser otro campo de tu DTO).
                // 3. Fallback a 'Desconocido'.
                doc.nombre_tipo_documento = doc.tipo_documento_nombre || 'Desconocido';

                // Asegura que el ámbito del documento esté en mayúsculas (para consistencia con tu JS)
                // 1. Usa doc.ambito_documento si ya viene de la BD.
                // 2. Si no, usa el ambitoKey actual (caso, asegurado, etc.) y lo convierte a mayúsculas.
                doc.ambito_documento = (doc.ambito_documento || ambitoKey).toUpperCase();
            });
        });
         //console.log("Documentos cargados y normalizados al inicio:", window.loadedDocuments); // Para depuración

                 // Función para agregar documentos a loadedDocuments cuando se suben nuevos archivos
        function addDocumentToLoadedDocuments(file, tipoDocumentoId, ambito, observaciones) {
            const documento = {
                file: file,
                tipo_documento_id: tipoDocumentoId,
                ambito_documento: ambito.toUpperCase(),
                observaciones: observaciones || '',
                uiIndex: crypto.randomUUID(),
                nombre_archivo: file.name,
                tipo_mime: getFileMimeType(file.name.split('.').pop() || ''),
                nombre_tipo_documento: $('#categoriaDocumento option:selected').text(),
                isNew: true // Marcar como nuevo para diferenciarlo de los existentes
            };

            const ambitoKey = ambito.toLowerCase();
            if (window.loadedDocuments[ambitoKey]) {
                window.loadedDocuments[ambitoKey].push(documento);
            }

            return documento;
        }

    </script>

    <script>
        // =====================================================================
        // Lógica de Navegación entre Pestañas del Formulario
        // (Este bloque estaba en tu .js pero se puede consolidar si es pequeño)
        // =====================================================================
        $(document).ready(function () {
            const $tabs = $('#tabsChecklist a.nav-link'); // Selecciona todos los enlaces de las pestañas

            function switchTab(offset) {
                const $current = $tabs.filter('.active');
                const currentIndex = $tabs.index($current);
                const newIndex = currentIndex + offset;

                if (newIndex >= 0 && newIndex < $tabs.length) {
                    $tabs.eq(newIndex).tab('show');
                }
            }

            $('.btn-next-tab').on('click', function () {
                switchTab(1);
            });

            $('.btn-prev-tab').on('click', function () {
                switchTab(-1);
            });

            // Re-inicializar tooltips para elementos que puedan existir al cargar la página.
            // Los tooltips de elementos dinámicamente añadidos se re-inicializarán en analisis-caso.js.
            $('[data-bs-toggle="tooltip"]').tooltip("dispose").tooltip();
        });
    </script>

    <script>
        window.casoId = "@Model.CasoDetalle.caso_id";
        window.aseguradoId = "@Model.CasoDetalle.asegurado_id";
        window.vehiculoId = "@Model.CasoDetalle.vehiculo_id";
        window.usuarioId = "@usuarioId";
    </script>

    @* Carga tu archivo JavaScript principal. Asegúrate de que esté en la ruta correcta. *@
    <script src="~/js/analisis-caso.js"></script>
}